<!doctype html>
<html>
    <head>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        [## Title ##]

        <meta name="description" content="Slidevs Controls - Control your Slidevs right from your mobile device">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

        [## Assets ##]
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

    </head>
    <body class="controls">

        [## Socket-connection ##]

        <div class="note-canvas">
            <div class="save">
                <div class="disk">
                    <div class="label-one"><div class="white"></div></div>
                    <div class="label-two"></div>
                </div>
            </div>
            <div class="erase">
                <div class="eraser">
                    <div class="point"></div>
                </div>
            </div>
            <div class="close">
                <div class="close-stripe left-right"></div>
                <div class="close-stripe right-left"></div>
            </div>
        </div>

        <div class="saved-message">
            Your note has succesfully been saved!
        </div>

        <div class="note-tap">
            Tap here to open up the note of this slide.
            <div class="orientation-warning">Drawing notes should be done in landscape!</div>
        </div>

        <div class="controls-wrapper">
            <div class="control right">Next</div>
            <div class="control left" style="opacity:.6;">Previous</div>
            <div class="current"> Current slide: <span class="slide-number">-</span> </div>
            <div class="connection">Not connected...</div>
        </div>

        <script type="text/javascript">

            $(document).ready(function() {

                if ($('input.socket-connection').length !== 0) {

                    var socket = io.connect($('input.socket-connection').val()),
                        left = $('.left'),
                        right = $('.right'),
                        slideNumber = $('.slide-number'),
                        connection = $('.connection'),
                        tapToNote = $('.note-tap'),
                        saveSucces = $('.saved-message'),
                        noteControls = {
                            save: $('.save'),
                            erase: $('.erase'),
                            close: $('.close'),
                        },
                        slides = {
                            total: 0,
                            current: 1,
                            update: function(first, last) {
                                slideNumber.empty().append(this.current + '/' + this.total);
                                first ? left.css({ 'opacity' : '.6' }) : left.css({ 'opacity' : '1' });
                                last ? right.css({ 'opacity' : '.6' }) : right.css({ 'opacity' : '1' });
                            }
                        };

                    socket.on('totalSlides', function(ts) {
                        slides.total = ts;
                        slides.update(true, false);
                        connection.css({ 'background-color' : '#1DC64F', 'border-color' : '#19A743' });
                        connection.text('Connected!');
                        setTimeout(function() { connection.css({ 'opacity' : '0' }); }, 800);
                    });

                    socket.on('updateSlideNumber', function(slide) {
                        slides.current = slide.number;
                        slides.update(slide.first, slide.last);
                    });

                    left.click(function() { socket.emit('slide', 'left'); });
                    right.click(function() { socket.emit('slide', 'right'); });

                    var notes = [], createdCanvas, createdContext;

                    tapToNote.click(function() {

                        if($('.orientation-warning').css('display') === 'none') {

                            socket.emit('openNote');
                            $('.note-canvas').css({ 'height' : '100%' });
                            $('.save, .erase, .close').css({ 'opacity' : '1' });

                            setTimeout(function() {

                                if(!createdCanvas) {

                                    var canvas = document.createElement('canvas');
                                        canvas.setAttribute('class', 'note');
                                        canvas.setAttribute('width', $('.note-canvas').width());
                                        canvas.setAttribute('height', $('.note-canvas').height());
                                        $('.note-canvas').append(canvas);
                                        if (typeof(G_vmlCanvasManager) !== 'undefined') canvas = G_vmlCanvasManager.initElement(canvas);
                                        createdCanvas = canvas;

                                    var context = canvas.getContext('2d');
                                        context.strokeStyle = '#4F4F4F';
                                        context.lineJoin = 'round';
                                        context.lineWidth = 4;
                                        createdContext = context;

                                }

                                var note = {
                                        draw: {
                                            isDrawing: false,
                                            start: function(x, y) {
                                                notes[slides.current].add(x, y);
                                                createdContext.beginPath();
                                                createdContext.moveTo(x, y);
                                                this.isDrawing = true;
                                            },
                                            move: function(x, y) {
                                                if (this.isDrawing) {
                                                    notes[slides.current].add(x, y);
                                                    createdContext.lineTo(x, y);
                                                    createdContext.stroke();
                                                }
                                            },
                                            end: function() {
                                                this.isDrawing = false;
                                            }
                                        }
                                    };


                                // Create or redraw note
                                if(!notes[slides.current]) {

                                    notes[slides.current] = {
                                        x: [], y: [],
                                        add: function(x, y) {
                                            this.x.push(x);
                                            this.y.push(y);
                                        },
                                        reset: function() {
                                            this.x.length = 0;
                                            this.y.length = 0;
                                            createdContext.clearRect(0, 0, createdContext.canvas.width, createdContext.canvas.height);
                                        }
                                    };

                                } else {

                                    var existingNote = notes[slides.current];
                                    for (var i = 0; i < existingNote.x.length; i++) {
                                        createdContext.beginPath();
                                        createdContext.moveTo(existingNote.x[i-1], existingNote.y[i-1]);
                                        createdContext.lineTo(existingNote.x[i] - 1, existingNote.y[i]);
                                        createdContext.closePath();
                                        createdContext.stroke();
                                    }

                                }

                                // Touch
                                createdCanvas.addEventListener('touchstart', function(event) {

                                    var x = event.targetTouches[0].pageX,
                                        y = event.targetTouches[0].pageY;

                                    socket.emit('draw', { action: 'start', x: x, y: y });
                                    note.draw.start(x, y);

                                }, false);

                                createdCanvas.addEventListener('touchmove', function(event) {

                                    var x = event.targetTouches[0].pageX,
                                        y = event.targetTouches[0].pageY;

                                    socket.emit('draw', { action: 'move', x: x, y: y });
                                    note.draw.move(x, y);

                                }, false);

                                createdCanvas.addEventListener('touchend', note.draw.end, false);

                                // Save/erase/close
                                var closeNote = function(saved) {
                                    $('.note-canvas').css({ 'height': '0' });
                                    $('.save, .erase, .close').css({ 'opacity' : '0' });
                                    createdContext.clearRect(0, 0, createdContext.canvas.width, createdContext.canvas.height);
                                    socket.emit('closeNote');
                                    if (saved) {

                                    }
                                }

                                noteControls.erase.click(function() {
                                    socket.emit('erase');
                                    notes[slides.current].reset();
                                });

                                noteControls.save.click(function() {

                                    var createdNote = createdContext.getImageData(0, 0, $('.note-canvas').width(), $('.note-canvas').height()),
                                        compositeOperation = createdContext.globalCompositeOperation;

                                    // Color background before exporting
                                    createdContext.globalCompositeOperation = "destination-over";
                                    createdContext.fillStyle = '#FCFCFC';
                                    createdContext.fillRect(0, 0, $('.note-canvas').width(), $('.note-canvas').height());

                                    socket.emit('savedNote', createdCanvas.toDataURL('image/jpeg;base64;'));
                                    noteControls.save.css({ 'opacity' : '.2' });

                                });

                                socket.on('noteRecieved', function() {
                                    closeNote();
                                    saveSucces.css({ 'opacity' : '1' });
                                    setTimeout(function() {
                                        saveSucces.css({ 'opacity' : '0' });
                                    }, 1500);
                                });

                                noteControls.close.click(function() {
                                    closeNote();
                                });

                            }, 500);

                        }

                    });

                    document.body.addEventListener('touchmove',function(event) {
                        event.preventDefault();
                    }, false);

                    socket.on('refresh', function() {
                        location.reload(true);
                    });

                }

            });

        </script>

    </body>
</html>